---
- name: Install and configure ArgoCD
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tasks:
    # Deploy ArgoCD
    - name: configure argocd namespace
      kubernetes.core.k8s:
        src: "argocd/namespace.yml"
      failed_when: false

    - name: configure argocd operatorgroup
      kubernetes.core.k8s:
        src: "argocd/operatorgroup.yml"

    - name: configure argocd subscription
      kubernetes.core.k8s:
        src: "argocd/subscription.yml"
      register: deploy_argocd
      until: "deploy_argocd.result.status.state == 'AtLatestKnown'"
      retries: 10
      delay: 10

    - name: configure argocd cluster role binding
      kubernetes.core.k8s:
        src: "argocd/clusterrolebinding.yml"

    - name: configure argocd repo
      kubernetes.core.k8s:
        template: "argocd/repo.yml"

    - name: configure argocd initial application
      kubernetes.core.k8s:
        template: "argocd/application.yml"

    - name: configure SSH secret
      kubernetes.core.k8s:
        resource_definition:
          kind: Secret
          apiVersion: v1
          metadata:
            name: argocd-github-ssh
            namespace: aap-as-a-service
            annotations:
              tekton.dev/git-0: github.com
          type: Opaque
          data:
            id_rsa: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              38333130616264366532336662666561613636343166613264346262303963363465623464353130
              3038313064313432646433323430393361653664333861620a666631643364616239383465333461
              63636164643837373261626465623765363534366432366633326338373965623861333164373332
              6231376537653833330a306264386166316137626666656664363961656334363639393032646336
              38393631613234396539323236303037633062343864373266303065666466663434366536656139
              38616564343131303835323634613633396238633936623362636135363032353062646362366339
              34383239316637343535303339366665373830363763666638313330333434343863653535663537
              30316533396335376638316665336530646630316461316163643663666339336435343662346330
              65306261303739653237343130643432303162646131666335393634643930666662633263623331
              31396438646138396539316665303534643532656166363634356338613436393939373364356138
              38393431356564313433663865663364353932346637656432313739336437333931633338316136
              35363433316665373137326361336333316233656532376339613863383335643330323261623338
              35306534313537336261656663303737356262353761313231626536663165663461346432316364
              39616233316461353661313133613233323364393832393565306365386362316633336631383535
              31646633653334356263323866393131663664633765346133336665363631646339313734636237
              63393464353563363839636232393461623432326235366164353637316662323966643139626436
              33313436333734393733356462636437383537326332353061653266366163336438383130653339
              33643663623638313261353835633361303538623033373861333730363261616635393436343864
              61616434666232613865393063363937326362393230643335663130643532376665623364316562
              61333533353166646130346238363933666362643734336333373461626462323637366139326161
              32366266353363336333333637613165393039626166336562313634666265663433396566653631
              65336534666439333631353731356530393338396163393761383166326336343130633137323361
              66396531363635656537373033343966336666613733646465303364663065653330373039373737
              62383537303233623362

    - name: link SSH secret to pipelines service account
      kubernetes.core.k8s:
        resource_definition:
          kind: ServiceAccount
          apiVersion: v1
          metadata:
            name: pipeline
            namespace: aap-as-a-service
          secrets:
            - name: argocd-github-ssh

    - name: configure webhook secret
      kubernetes.core.k8s:
        resource_definition:
          kind: Secret
          apiVersion: v1
          metadata:
            name: webhook-secret
            namespace: aap-as-a-service
          type: Opaque
          data:
            secretToken: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              35396562356330666261393466613338323763326661326563366539643364633930316633326330
              3031666538663164303631653163366562313566633636340a653961333739623665623539663230
              39366165626437373663383963316234356433323038366339323866636639666362613163363830
              6231623537656562390a373039396164323161306531333061316465313238626539396532306134
              34333365323235316464636664306235306635333965633039613061336333653234366136343965
              3565333532346239623363613038323939646264303165346138
