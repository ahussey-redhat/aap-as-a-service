---
- name: Install and configure ArgoCD
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tasks:
    # Deploy ArgoCD
    - name: configure argocd namespace
      kubernetes.core.k8s:
        src: "argocd/namespace.yml"
      failed_when: false

    - name: configure argocd operatorgroup
      kubernetes.core.k8s:
        src: "argocd/operatorgroup.yml"

    - name: configure argocd subscription
      kubernetes.core.k8s:
        src: "argocd/subscription.yml"
      register: deploy_argocd
      until: "deploy_argocd.result.status.state == 'AtLatestKnown'"
      retries: 10
      delay: 10

    - name: configure argocd cluster role binding
      kubernetes.core.k8s:
        src: "argocd/clusterrolebinding.yml"

    - name: configure argocd repo
      kubernetes.core.k8s:
        template: "argocd/repo.yml"

    - name: configure argocd initial application
      kubernetes.core.k8s:
        template: "argocd/application.yml"

    - name: configure SSH secret
      kubernetes.core.k8s:
        resource_definition:
          kind: Secret
          apiVersion: v1
          metadata:
            name: argocd-github-ssh
            namespace: aap-as-a-service
            annotations:
              tekton.dev/git-0: github.com
          type: Opaque
          data:
            id_rsa: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              37333235333534646337376466623632303365643963613332303235383464653430336333643738
              3732326232616265643466633564363532613337376562360a326133313336653663613065386137
              63323765303132323230316130363862333738643236656237376432303762373733363838353737
              6436333036656361630a623436366433386361666235613963633362323761346139303436363464
              34373064363033313966353336636138366161663635326265346362313161383635326531363366
              31613538656331326263323731393132383963346533373333666136323565633931623239333137
              36656431616638336337366462356138626432386638336130373563613733366138616639393064
              34616265363933323732336535306262666635646636613234363934653861343531383964343234
              36353037303663363035663162326163613566663365333262336138633461303539633962393935
              66636331376466633832646537353238636530653738643765323663303535373036653938643365
              32636138663233373861666234313730663435626162616336386233333832303436366238336638
              33626364393535356336353164633464313431386264396661326130613963663532306631646432
              38653561623632343836333732313234616431396535393039643035613464623334333439616265
              66653566643332656135303533303763353837353062323233356266663066663834393938356231
              31643137363666326431326334663031353133393762383637353735653564316362646565663438
              38666538316165336662393935643337333361336162643962306139613830393565343037363838
              65643937333238636162326562366435623836643666616564656166653637343036363232666462
              63396430643932353338326435366532633132643835643563646234376235353933316164316433
              36626230613537323730643966636464303036633462373936663263646431323561613938633566
              61636365326236633934373662353134633962653533333365326533393961313739356561303037
              30633365303436643239653436306461633536633033306464383166383661373434616361666337
              36396232623637623235303238346463376437306537313732383362613663303262326330393465
              30643337383663306138303366653235373961323063666462393362393939643535363139666639
              66333930333338336263653631623936366131353032386235386361353835313865656534666234
              63316631356666346636376337643466643936636166343761336430666532396264316462616133
              61656636653737643031366531373539396565353361626661346239646330646530636431323364
              31663536363866313931663365666166666461363262306631363336333230626562373931343638
              64343564616638373663353932346430373239316533633538363033376131343037636362316132
              62663039353632356537613364306265643066353462633238383865353664363831356532616433
              66366462336131396235363436303136393833643838626434613765323939613139363063393564
              64623863353661663464623534633836383032336334303533363132303235623535323764383138
              62366634663137623163303062616638653563633964613837383366386462383062386238663836
              36366665363135326235383431353830613031663766623337663031396636386439313966386138
              33653734303066323937333361306130303735306163373666616430616334363463636639653835
              39343034316433373961666239643239393537663035656330386462393466356465643736323333
              33346165663166313936323838333361313137646131366263366632613031353662303237376230
              38646665663335613430646266346366666530383533343537343433623764356533303333333061
              3465383833356162633630363733393337626561303536396135

    - name: link SSH secret to pipelines service account
      kubernetes.core.k8s:
        resource_definition:
          kind: ServiceAccount
          apiVersion: v1
          metadata:
            name: pipeline
            namespace: aap-as-a-service
          secrets:
            - name: argocd-github-ssh

    - name: configure webhook secret
      kubernetes.core.k8s:
        resource_definition:
          kind: Secret
          apiVersion: v1
          metadata:
            name: webhook-secret
            namespace: aap-as-a-service
          type: Opaque
          data:
            secretToken: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              34386337393537306131376232316433343732663233646666306334346266383364363062343738
              6538636330363035616232376434333831343039613035390a646534313732346463626265366434
              62316430306437346165386433373662323465353933343633633765313234306234343833666661
              6536303864613236630a336563653135333539613864383765343231323431363336396531386335
              37643365383630313139623139356237616132343564666633646431306330353232
