---
- name: Install and configure ArgoCD
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tasks:
    # Deploy ArgoCD
    - name: configure argocd namespace
      kubernetes.core.k8s:
        src: "argocd/namespace.yml"
      failed_when: false

    - name: configure argocd operatorgroup
      kubernetes.core.k8s:
        src: "argocd/operatorgroup.yml"

    - name: configure argocd subscription
      kubernetes.core.k8s:
        src: "argocd/subscription.yml"
      register: deploy_argocd
      until: "deploy_argocd.result.status.state == 'AtLatestKnown'"
      retries: 10
      delay: 10

    - name: configure argocd cluster role binding
      kubernetes.core.k8s:
        src: "argocd/clusterrolebinding.yml"

    - name: configure argocd repo
      kubernetes.core.k8s:
        template: "argocd/repo.yml"

    - name: configure argocd initial application
      kubernetes.core.k8s:
        template: "argocd/application.yml"

    - name: configure SSH secret
      kubernetes.core.k8s:
        resource_definition:
          kind: Secret
          apiVersion: v1
          metadata:
            name: argocd-github-ssh
            namespace: aap-as-a-service
            annotations:
              tekton.dev/git-0: github.com
          type: Opaque
          data:
            id_rsa: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              38333130616264366532336662666561613636343166613264346262303963363465623464353130
              3038313064313432646433323430393361653664333861620a666631643364616239383465333461
              63636164643837373261626465623765363534366432366633326338373965623861333164373332
              6231376537653833330a306264386166316137626666656664363961656334363639393032646336
              38393631613234396539323236303037633062343864373266303065666466663434366536656139
              38616564343131303835323634613633396238633936623362636135363032353062646362366339
              34383239316637343535303339366665373830363763666638313330333434343863653535663537
              30316533396335376638316665336530646630316461316163643663666339336435343662346330
              65306261303739653237343130643432303162646131666335393634643930666662633263623331
              31396438646138396539316665303534643532656166363634356338613436393939373364356138
              38393431356564313433663865663364353932346637656432313739336437333931633338316136
              35363433316665373137326361336333316233656532376339613863383335643330323261623338
              35306534313537336261656663303737356262353761313231626536663165663461346432316364
              39616233316461353661313133613233323364393832393565306365386362316633336631383535
              31646633653334356263323866393131663664633765346133336665363631646339313734636237
              63393464353563363839636232393461623432326235366164353637316662323966643139626436
              33313436333734393733356462636437383537326332353061653266366163336438383130653339
              33643663623638313261353835633361303538623033373861333730363261616635393436343864
              61616434666232613865393063363937326362393230643335663130643532376665623364316562
              61333533353166646130346238363933666362643734336333373461626462323637366139326161
              32366266353363336333333637613165393039626166336562313634666265663433396566653631
              65336534666439333631353731356530393338396163393761383166326336343130633137323361
              66396531363635656537373033343966336666613733646465303364663065653330373039373737
              62383537303233623362

    - name: link SSH secret to pipelines service account
      kubernetes.core.k8s:
        resource_definition:
          kind: ServiceAccount
          apiVersion: v1
          metadata:
            name: pipeline
            namespace: aap-as-a-service
          secrets:
            - name: argocd-github-ssh

    - name: configure webhook secret
      kubernetes.core.k8s:
        resource_definition:
          kind: Secret
          apiVersion: v1
          metadata:
            name: webhook-secret
            namespace: aap-as-a-service
          type: Opaque
          data:
            secretToken: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              35396562356330666261393466613338323763326661326563366539643364633930316633326330
              3031666538663164303631653163366562313566633636340a653961333739623665623539663230
              39366165626437373663383963316234356433323038366339323866636639666362613163363830
              6231623537656562390a373039396164323161306531333061316465313238626539396532306134
              34333365323235316464636664306235306635333965633039613061336333653234366136343965
              3565333532346239623363613038323939646264303165346138

    - name: configure AAP manifest secret
      kubernetes.core.k8s:
        resource_definition:
          kind: Secret
          apiVersion: v1
          metadata:
            name: manifest
            namespace: aap-as-a-service
          data: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            65663839326131366136646238386337313731326462623637663336323765316466626566393635
            3238306532623933383864663736323238316639346461340a643066666261303638646230313438
            62343433353832643134316233346265336363393235613261323331306164626630303533356237
            3566616664316334660a663764323461333038646463623337363663383832306566376230626563
            65303431313532663961376435383630623966663130396566323230353639313934326538336561
            63313236323535633432376165393962376465613932626638366537363863323232363032386436
            65396532666561373765396335393862653735383662623166623937313532333539613030326630
            31303665396461396434303137663031316535316139643265333163326631363564653632303335
            66343634653937336337636631373436646133313839623333333530306538326566376134643437
            38666438303534383730386538303935623730353165313631366536376339386638353662306431
            64343934663064326362393966376634613966626461393061336337646565633931323561356664
            36383839636430656662343131653437353138396530353735303431323565333334616166616263
            36313135343362326633613838666164396531313232636436333634393061383765336332353765
            61643738363336303131313865316461336239383934313462356263613466356530653736613661
            37653339643230656235303865323364376166633337366633393063656235356136376634666431
            61326336376162653736363764353439366238623432323735613832663835303337303063303138
            65623937346433633137656338346236396234613531653563656338353166626363613238316266
            35336139306330663162323938636163616234386532313339323134356636333035336233643538
            65366562636366323035643962663134306630333061303665383931333665663561396363633839
            36316434343835653139366262343935366133323065626631636630376166633633306166643532
            34353264396562336339386531653132623264643562393936636439343039336163323635373065
            33356565306463313237343431346132386161363761346263363038396561336238323337323931
            30333431666131353135613935326633353534386439326233366638353630346361646137383037
            37316237653236643036316339346236653762616432626234623266363062373137346137376335
            30393065626334633532623862613665346630613963613435613865643538626131613234383933
            63346634346266373038653138656433666138653031343065643063343664383266306331343164
            30326263333431346565316135623165353664343562356230353430633962663461616363393264
            32303062616532303735323261386666313361616364333661383637623932653664313065396464
            33386365363835366536303464626263393465626133316332626637333136316531383037343635
            30323832343564393232663062653536623730313463656465313837363666633137636262393130
            62303863616131333134653162666332363538666161643332373566616662343038356532343162
            34626435356166316437636265336632326239643334643965613261353835333439343431363661
            33646331633530623534316333396136336161666266613133333961656237626332366465353939
            32653766333937613365343065326137623861336134303837383939383366633137346435386136
            37396437633732353235386435656263383236396631393237653466303561333464303763373564
            66336263613666643435626530366334623439636261653263376335353137386162613062346563
            34653862636532313539643038383961323239323938666431666136346339663263373064316231
            33646235643236656161653337383566356136623432623864646262613266336162383331393634
            39313965333838666136623434383063356236363161633663333761326663343130363161363763
            34623437653436663830303836353562326138643561643764373161333731336636336464353930
            66393531623331323330303536626162393764613632313038373865653339373236346537336434
            32323931653838353162306637393238313332396430313033653866626633663733643737333338
            64353166396462613538656234386438633330656339663532653239646438326462396633336662
            66663939313230663336386262313338393539626233346236653439333935326263366362333362
            39356338356535386439636230386163623161653365646666393762363465336466363539613932
            35393866626539646630613366326565336231346536393830373938326466346438353865333636
            37313431326364666331653133326663633238663265653261303636393666376333346231393236
            31666632396163336561616563613066396366333366633635616438366461303065613265613335
            33396132396530656333636262363737633336613434343337393732366239343562663334326135
            33316231343663323235643161656633336435643138613333356461303763626466616434386333
            30663266376666643763616365646661646231396238656634386133646166623236393230326538
            39366530653135323762313164616365653462663036333861353535383963343462356266616166
            34333963666334613061303135323830313366376134653135333661646638346664646436306537
            35643365373761653235393731393661336539663466383733373631643762353763633230663634
            37353435633364666136646130636465303163313165373061336161636534373437383738333162
            33316538373764376338646433336636303536343534363664623336623138316466306264363966
            31646465353330343730623138643763616538613331313531376433643563383733376339366664
            64643464353764663936613264303233653266336538626466643031393631613335636137393866
            32353564316439383565626237656362663736323330633362303862323630393066376231336164
            34333738663464333166393139306535393632343036313061366634343566343137623735326231
            32383332346637323838633663363561653563643235653838316464313032316561393461336362
            61646463353837383561643835626166356265376362393761656133643637306163616366616433
            31363138373332343732383030383366353138303836333539616232643362383264323766653039
            39623330346230613836643230346161373430343633666362396539303239303466323936343730
            66366533386664333765386130643739613863656662666632363036363031303136346139303335
            64383734643339343631303261373537343763303633376635636339343161613861343432616262
            38326139366462353333303136373033656535366130613539393362613634366665316661336161
            64336431376633363238353238316662346564623962326466383034623461333963356137366236
            63636139376230303631313035626235613563656563343433386265363430353130643830333861
            36356231386234653063616162313539623438363236326166343633626266393464656237663831
            64333162633231323366333232396536653066646639343437323938373864306330643665653637
            31336361303235396339303666663539303530313639616330656263343063616338643034363035
            39663263393362303735653431326233663764303230643335323832383766386166316630386537
            63643836393261313632643436663630303866396662393764353066663066343338616132613635
            61396165343063323762323632316631636161663362653230393831313533373239666631633331
            37333136303435653439386137303234653634356462636239373566363161356237306638366661
            65623064656239656663333236363866656336306132656364633632393738353633366363653134
            39326266316531633133633639666434666230313363323266333039616433656362663834626638
            64383364666531356165623639633133383562656562616239336633313637306637656639626135
            32366638396233363332633539363263303533323265363237373866663732346132633132326162
            36396635383039333837666338633735646231306534646130653062346165366630343138306562
            64626434316132623531343132346363363764613739363333613436363261343563353130353733
            35313764303037363336643264633930623230663964313266333965643939666532376233306466
            62643737623962623462353738646565393337326161656230373161353637656332323935393032
            39306431333265333761616666643039643262656237366135353563393033663832646236346437
            61636531616135613739656364373833303630623538336238346132353035303130343032633061
            30323362636561343461333661666139383532316633363265633035353761646233383139386135
            37613336646333396334656166333437356664376533303231343866316338663463663935303439
            63366633383361613930353734333437323430306439336237363634663534323763363830636461
            38613061323836376438393238326433373165313961616462353764316332626536363634613564
            35396162393732363238376435313966363635313434353939343638373331303738313430616562
            65373763306434366362633962343632663631656366646639363639333264353036343863643235
            32636236316534353865616266643137636231316262623664373266356361636134663561303461
            31366166303963633337366363316536666461373234343239316439373336323638383331626333
            64633965363861393236303661623334356266616265396331616135373234376431396565333261
            33313136373235393936323938653737633830613561663933663234643263623532663132336130
            39373965376239613765376136633632373762376634346130316136323237653731313138623533
            32323537336434616134393133653535646563613630616266343236333437396662623133613339
            65326461643334613038316438333962613732313837613934363161353635633738323030373165
            37336438366537313662323965616137346437353262343834336434643664633236373731373737
            62636237636432313037663039393964363565396361303163336336666534323337616161343663
            63353933656664623665306138383836306234326635623630383635366231383534643136376636
            37313738626463323865623363366633303165656265363438343962366135396630333434623136
            35623831323033613762376463353064376336393461373139366434313234333135656264343062
            66623536656137626564646563616262396466356334343332613330393933636239326566666238
            61656361396565646436303061326530666434356237353937643136653338356234323465393530
            32633564383461326465623938643961616539666261373861653865646530316330353332613638
            30613964343435346135636166643563363738356535663264396661623463346535313663333632
            61383037613231333339353132366463353239386535383766393137636666353336383862636162
            30376234386137386434633132393838623736366533393930613666356634643135633462393666
            33356266613562353539363333643436326531616561346330353533366462626464633438323235
            37366662366264613031316264656231653538376534336433323362316534666334353861643263
            65333134343965333333663961636133363237353330326237306463353536653537366332633634
            38353362646135306639353834396565626562333538316264623263323734656632313436333264
            63383132306333616233383039316331643438323563306639373264386538363235666237373866
            64353432663166393638373535393938333439626538303330346234353661333164306135613530
            64346131633530653831376261393266316337303665643038323264326330623364333866633536
            33666533343134313036383866626266326662306239643130393264363133393461393139366462
            61626239313732396637616365383339663433636330656463356636666536343662393464653737
            37326534393363633364323366643566323538343031646432633965623031643339396236646563
            38616235363463343435626534313235356265356464306338663838636133373538653631643861
            33363538643836396433656663373238666364306237633930663434383261303636383363306364
            62616330663865656264346332653064363232313730366532383034343366386363613032353263
            30333061613135313262633238313839353935663563316336663165383066653763623565363930
            33383038356366616664653764636435306632653664613464393739393362323662346531383766
            66653239343330616530636166306661376566386465383532366261343962643036303631383439
            66643964616466613333353638303030326333346332386538366139336636366238396637343561
            63393534326564393634323266663031336234393264376463623731383139396363366662396339
            35303964373766356637656461666331353536373436633563333939643561316539356537643839
            61636164643235636664366235663765306362396133633838366432373434373238343063393031
            63323731383032613161343635613762313566353930616330306336336432336230346165363365
            38313530316137663466636632643965653630353738653663613061623337333164386335353534
            31666438336635343965653532343139626633343136316536316133386538613638613762646338
            62336136383363306466663362303036383466346138393038393465363235373937393738613866
            62346336396530323865333230363237383131316233663361613132626361393064393031343339
            37393265373335653663393837316133353632343364643038303839636165373937326564653435
            35613262353465666632663135366537653831336530303135613236306665336664343833336665
            36626436613664333630353836336134393365393539666431353362323563343034626234363239
            37396365356564383830643631653765626432383236363831643462666530393665656661346335
            35643834326237343863336664356366653962626133343865323866623638636339653939626364
            39323937343932323265333332346637623664373232636665383730346166393930633863613761
            39316664313032396465353530356438663936373437333633336366383737383361646439616632
            35646435373835303262663635323532373232613634343535336563626564353035333961373631
            63653934633835636463323630353833636438663934663537333434666635326238626561613230
            37623230656632326338373866303864643965626537396531383563383331356465376631333831
            37396239626434663937613038636336323239313037303831383266323535303036336562323733
            35303331336364666433623834333261616135613533303231333237613039373361316531613562
            33383164653561353065346437666663363831366665396661333837623232313532323934656636
            35393933613864646163623736616232636361626635376533626133643762373331323463306537
            31663536313733386436323862353834653038663734316531366530636663303331656464663034
            31653239376536663366633237663266353732666665343636663537623735333764623730393062
            33373936343432386165663630363433613261616434373234336130343032336262323664396530
            37633835663639303333613161376230343635653166643732383764313963333739356664316532
            37303837313662343038333434613231633634306362323361383539303435373763333862613232
            32366365343863666365316564303034396363373262383266653362383862623137646437613161
            31366462316337373361663438343434636130356638356633333664636536636136313862663165
            62396462636335626437353939353633303865613561383838343261643963363538656563343962
            64323932356161303336313134643633663332636632393561616634373533393732653761616164
            64333732303738373863333036386535646665663433653539343338343937353332303039653732
            39633564393736316538326361353733653963336463356637366430353364303062656434366238
            62373066613666383433653238396463656362376439396331666363643933336437386331663038
            36643766353938383632373561383638333736626666333432663837643762343765616362363630
            36653938623537343034653735353832363366366664343333336261353030383438326562613731
            33653064316231373730353433303361633339396165653030623832316333373466646131373462
            36653032323437316164303566663632376261333739356438666333323761643630656537626230
            63316630653630666130336564633633393366326463363131383035646535303464303038343031
            31303934323838656266626336633237366437653038633732366430643665616636393337666562
            32646339333438383266363734343463373033646564663333323737376230353561636139303563
            36363536323030303533366463366636666239313265636663306261613931633230626261373931
            37346438623233313935633863623933366633633166303265623939616333303937356334663164
            34346566313437363464303364663139313561313933316435383831396535386136613235313136
            30643036343665646164303233623331323530326137323530333538333437633163616434336662
            65353637633765666231386434343838393261653161383662613962353932646331633233396630
            36633639313561303362303666346439633038383862616538393536363739393665616333306263
            63326531663064653131636437613032313235306161313561643361323437346666383539396538
            30383336363737633935636266636133633362383766623765613335636331393363306133303665
            34396264336262636430633737653863316162613862306337643032323037313163616436346362
            38323462653663633136383439313739363666343964373539366234663839663530373931656666
            62653838366134656533633865656665366239396165393565383234396634613764386333623036
            61396333396338633832323964306165663062373865306532363431373665343265396638383938
            63643833323366383636623162613364623731616538323239376535623239366461316639366665
            34623865663033613239633336626165613462663534626632386437653537613235613963373630
            38303264393336313333636262386263636161633663383662353331653231306564373833616633
            31613664306434356466323966346562346332663331623732316230636235643634306132643835
            39626361356661396561646331646666323261363362303833383966363761646632323563663531
            31343933366366356466353661343039343037333333623164363166366365313238363461323435
            66333732343661613761333233356163303034626336646665306166313630326362643135393538
            37306139343431356530663430363064613230666537336331616338353438653135346334336361
            65646266376533396565653066653363326133346330376535313333336530623236376363343163
            37306561346538663461376136346337376534336666666235316633616265633461396136363231
            38646636356636303865653162323666366466393830633732336665353139653164623536373439
            33616266383237656139656563623830636431656134333531633362363162373833356564316430
            61326565616130323536333336333164613633643233303562373737313865623266643465356237
            64366437616265313466346262613831323033383363353566343261336361366262326638643166
            31366166333430313634323566373265366161653635306639633732353138333035376566393539
            38356430633164386435643930353331353434326232393564343237373162363962383637353634
            37353461383030303032666137623333366130366331653639663864663764376334653461376365
            65373334656463303335333632343761393336366239326265333032353131386535363430343635
            66663666353062616666653832323863363038633736613139306564343039666365313938626563
            61326365633232343138316566383838333963663330623130663636656238383639316531656437
            65313463336630646166653662613834633666313963383333306661663862363931343265393239
            61373830343339653232303565353831656635633434303230373632656161323939356638316363
            35336266633630663131633136313735356430323862373734623339313537316634393862633235
            64353235303963353631386237613866613631313430623136396265643263356436633439646136
            62353831353166323965306532363534303563383535303832393562663065643135653334623737
            31383831353738336130616630333861386263653537653635373066346530316437366434346334
            62373137386164323636356163353236633232313763616233666261343161346138623031636137
            36313932643063643338613330353861663634366564646334353435373133663530343036393066
            6536
          type: Opaque
